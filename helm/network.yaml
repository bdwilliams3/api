apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: k-api-logging-bridge
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: k-api
  policyTypes: [Egress]
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: logging
    ports:
    - protocol: TCP
      port: 8123
---
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: api-route
  namespace: default
spec:
  gateways:
  - api-gateway
  hosts:
  - sample-api.com
  http:
  - route:
    - destination:
        host: k-api-service
        port:
          number: 8080
---
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: api-gateway
  namespace: default
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "sample-api.com"
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cloudflared-egress
  namespace: cloudflare
spec:
  podSelector:
    matchLabels:
      app: cloudflared
  policyTypes: [Egress]
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: istio-system
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-loki
  namespace: logging
spec:
  podSelector:
    matchLabels:
      app: loki
  policyTypes: [Ingress]
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: grafana
    ports:
    - protocol: TCP
      port: 3100
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: otel-collector-ingress
  namespace: logging
spec:
  podSelector:
    matchLabels:
      app: otel-collector
  policyTypes: [Ingress]
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: default
      podSelector:
        matchLabels:
          app: k-api
    ports:
    - protocol: TCP
      port: 4317
    - protocol: TCP
      port: 4318
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: otel-collector-egress
  namespace: logging
spec:
  podSelector:
    matchLabels:
      app: otel-collector
  policyTypes: [Egress]
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: tempo
    ports:
    - protocol: TCP
      port: 4317
  - to:
    - podSelector:
        matchLabels:
          app: loki
    ports:
    - protocol: TCP
      port: 3100
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: loki-ingress
  namespace: logging
spec:
  podSelector:
    matchLabels:
      app: loki
  policyTypes: [Ingress]
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: otel-collector
    - podSelector:
        matchLabels:
          app: grafana
    ports:
    - protocol: TCP
      port: 3100
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tempo-ingress
  namespace: logging
spec:
  podSelector:
    matchLabels:
      app: tempo
  policyTypes: [Ingress]
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: otel-collector
    - podSelector:
        matchLabels:
          app: grafana
    ports:
    - protocol: TCP
      port: 4317
    - protocol: TCP
      port: 3200
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: grafana-egress
  namespace: logging
spec:
  podSelector:
    matchLabels:
      app: grafana
  policyTypes: [Egress]
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: loki
    ports:
    - protocol: TCP
      port: 3100
  - to:
    - podSelector:
        matchLabels:
          app: tempo
    ports:
    - protocol: TCP
      port: 3200
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53